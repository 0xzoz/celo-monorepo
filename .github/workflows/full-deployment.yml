name: Deployment to all environments from STG

on:
  # Allows you to run this workflow manually ONLY
  workflow_dispatch:
    inputs:
      release-package:
        description: 'Which package should be released in the workflow'
        required: true
        default: 'none'

jobs:
  Release-to-Alfajores:
    runs-on: ubuntu-latest
    environment: ALFAJORES

    steps:
      - name: Checkout repo
        uses: actions/checkout@v2
        with:
          fetch-depth: 1
      - name: Set up gcloud Cloud SDK environment
        uses: google-github-actions/setup-gcloud@94337306dda8180d967a56932ceb4ddcf01edae7
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }} # optional
          project_id: ${{ secrets.GCP_PROJECT_ID }} # optional
      - run: ./packages/${{github.event.inputs.release-package}}/release/deployment.sh
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          ENV_NAME: "ALFAJORES"
          NETWORK: "alfajores"

  Test-Alfajores:
    environment: ALFAJORES
    runs-on: ubuntu-latest
    needs: Release-to-Alfajores

    steps:
      - uses: actions/checkout@v2
      - run: ./packages/${{github.event.inputs.release-package}}/release/test.sh
        env:
          ENV_NAME: "ALFAJORES"
          NETWORK: "alfajores"